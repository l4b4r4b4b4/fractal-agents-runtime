# Task-02: Create Infra Package (`packages/python/infra/fractal_agent_infra/`)

> **Status:** ðŸŸ¢ Complete
> **Parent:** [Goal 19 â€” Package Structure Refactor](../scratchpad.md)
> **Phase:** 2 (3-Layer Split)
> **Completed:** 2026-02-12 â€” Session 5

---

## Objective

Extract shared runtime infrastructure into a standalone package that both graphs and the runtime application depend on. This package provides tracing, auth middleware, and store namespace conventions â€” things that are **not** graph logic but are needed by multiple consumers.

---

## Implementation Plan

### Directory Structure

```
packages/python/infra/fractal_agent_infra/
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ README.md
â”œâ”€â”€ uv.lock                              # Generated by `uv lock`
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ __init__.py
â””â”€â”€ src/fractal_agent_infra/
    â”œâ”€â”€ __init__.py                       # exports key functions
    â”œâ”€â”€ tracing.py                        # Langfuse init, callback handlers
    â”œâ”€â”€ store_namespace.py                # Canonical namespace convention
    â””â”€â”€ security/
        â”œâ”€â”€ __init__.py
        â””â”€â”€ auth.py                       # LangGraph SDK auth (Platform deploy)
```

### Files to Create

1. **`pyproject.toml`**
   - `name = "fractal-agent-infra"`
   - `version = "0.0.0"`
   - `requires-python = ">=3.11.0,<3.13"`
   - Dependencies (minimal â€” only what the 3 files actually import):
     - `langfuse>=3.14.1` (tracing.py)
     - `langgraph-sdk>=0.1.0` (security/auth.py)
     - `supabase>=2.15.1` (security/auth.py)
     - `langchain-core>=1.2.11` (tracing.py â€” for RunnableConfig type hint)
   - Build system: setuptools, `src/` layout, `include = ["fractal_agent_infra*"]`
   - Dev deps: `pytest`, `pytest-asyncio`, `ruff`
   - Ruff config: inherit from graph package (same `select = ["ALL"]` with tuned ignores)
   - Pytest config: `testpaths = ["tests"]`

2. **`README.md`**
   - Brief description: Shared runtime infrastructure for fractal-agents-runtime
   - Explain it's a local path dependency for now, PyPI later
   - List what it provides: tracing, auth, store namespace

3. **`src/fractal_agent_infra/__init__.py`**
   - Export key public API:
     - `from fractal_agent_infra.tracing import initialize_langfuse, shutdown_langfuse, inject_tracing, is_langfuse_enabled`
     - `from fractal_agent_infra.store_namespace import build_namespace, extract_namespace_components`
   - `__version__` via `importlib.metadata`

### Files to Move (from `packages/python/fractal_agent_runtime/src/fractal_agent_runtime/`)

| Source | Destination | Changes Needed |
|--------|-------------|----------------|
| `tracing.py` | `src/fractal_agent_infra/tracing.py` | None â€” no internal imports to update |
| `utils/store_namespace.py` | `src/fractal_agent_infra/store_namespace.py` | None â€” self-contained module |
| `security/__init__.py` | `src/fractal_agent_infra/security/__init__.py` | None |
| `security/auth.py` | `src/fractal_agent_infra/security/auth.py` | None â€” no internal imports |

### No Internal Import Changes Needed

Unlike the graph package (Task-01), the infra files are all leaf modules â€” they don't import from each other or from the graph. This makes the move straightforward:

- `tracing.py` â€” imports only from `langfuse`, `langchain_core`, `os`, `logging`
- `store_namespace.py` â€” imports only from stdlib (`typing`)
- `security/auth.py` â€” imports only from `langgraph_sdk`, `supabase`, `asyncio`, `os`

---

## Design Decisions

### Why a Separate Package (Not Just in robyn_server)?

1. **Graphs need `store_namespace`** â€” the `token.py` in the react_agent graph imports it. If it lived in `robyn_server`, graphs would have a runtime dependency. Infra as a middle layer breaks this cycle.
2. **Future multi-graph consumption** â€” as the graph catalog grows, multiple graphs may use `store_namespace` and potentially `tracing`.
3. **LangGraph Platform auth** â€” `security/auth.py` is needed when deploying graphs to LangGraph Platform, not when running in Robyn. It belongs in a shared layer, not in the server.

### Local Path Dep for v0.0.0, PyPI Later

The infra package is small (~450 lines across 3 files). Publishing to PyPI for v0.0.0 would be premature. Plan:
- v0.0.0: local path dependency in `[tool.uv.sources]`
- v0.1.0+: evaluate whether there are enough consumers to justify a PyPI package
- When promoted: tag scheme `python-infra-v*` in release workflow

### What Does NOT Go in Infra

- `database.py` (Postgres pool, checkpointer factory) â€” this is runtime-specific, stays in `robyn_server`
- `config.py` (Robyn config parsing) â€” runtime-specific
- `storage.py` (in-memory/Postgres storage) â€” runtime-specific
- `agent_sync.py` (agent sync logic) â€” runtime-specific

---

## Acceptance Criteria

- [x] `packages/python/infra/fractal_agent_infra/` exists with all files
- [x] `tracing.py`, `store_namespace.py`, `security/auth.py` moved with zero modification to their logic
- [x] `uv sync` resolves all dependencies (85 packages resolved)
- [x] `uv run ruff check .` passes (all checks passed, 6 files unchanged)
- [x] Package is independently importable:
  - `from fractal_agent_infra.tracing import initialize_langfuse`
  - `from fractal_agent_infra.store_namespace import build_namespace`
  - `from fractal_agent_infra.security.auth import auth`

---

## Dependencies

- **None** â€” this task can be done first or in parallel with Task-01
- Task-01 (graph) and Task-03 (wiring) depend on this package existing

---

## Implementation Notes (Session 5)

- All three source files (`tracing.py`, `store_namespace.py`, `security/auth.py`) were copied with zero logic modifications â€” only `tracing.py` had a docstring update (`fractal_agent_runtime.tracing` â†’ `fractal_agent_infra.tracing`)
- `__init__.py` exports the full public API: all `CATEGORY_*` constants, `SHARED_USER_ID`, `GLOBAL_AGENT_ID`, `NamespaceComponents`, `build_namespace`, `extract_namespace_components`, plus all tracing functions. `__all__` is alphabetically sorted per RUF022.
- `security/__init__.py` left empty â€” consumers import directly from `fractal_agent_infra.security.auth`
- Ruff config includes `per-file-ignores` for `security/auth.py` â†’ `ARG001` (protocol-required unused args)
- `uv lock` resolved 85 packages; `uv sync` + `ruff check .` both clean on first run
- `security/auth.py` initializes a Supabase client at module import time (`supabase = create_client(...)` at top level). This is a side effect that only triggers if `SUPABASE_URL` and `SUPABASE_KEY` env vars are set. Fine for now but may warrant lazy initialization later.
- The `tracing.py` module sets `LANGCHAIN_TRACING_V2=false` at import time to disable LangSmith. This side-effect-on-import pattern is documented and intentional.
- 550 tests pass from `apps/python` with all imports updated to `fractal_agent_infra.*` (including `test_tracing.py` which had ~30 import references bulk-updated via sed)