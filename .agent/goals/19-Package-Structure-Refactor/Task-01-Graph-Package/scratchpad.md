# Task-01: Create Graph Package (`packages/python/graphs/react_agent/`)

> **Status:** ðŸŸ¢ Complete
> **Parent:** [Goal 19 â€” Package Structure Refactor](../scratchpad.md)
> **Phase:** 2 (3-Layer Split)
> **Completed:** 2026-02-12 â€” Session 5

---

## Objective

Create the first entry in the graph architecture catalog: a self-contained, portable ReAct agent with MCP tools. This graph must have **zero coupling** to any runtime (no `robyn_server` imports).

---

## Implementation Plan

### Directory Structure

```
packages/python/graphs/react_agent/
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ README.md
â”œâ”€â”€ uv.lock                          # Generated by `uv lock`
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ __init__.py
â””â”€â”€ src/react_agent/
    â”œâ”€â”€ __init__.py                   # exports `graph`, `__version__`
    â”œâ”€â”€ agent.py                      # Graph factory (DI for checkpointer/store)
    â””â”€â”€ utils/
        â”œâ”€â”€ __init__.py
        â”œâ”€â”€ mcp_interceptors.py       # MCP tool call auth error handling
        â”œâ”€â”€ token.py                  # MCP OAuth token exchange & caching
        â””â”€â”€ tools.py                  # RAG tool factory
```

### Files to Create

1. **`pyproject.toml`**
   - `name = "fractal-graph-react-agent"`
   - `version = "0.0.0"`
   - `requires-python = ">=3.11.0,<3.13"`
   - Dependencies: `langgraph`, `langchain-core`, `langchain`, `langchain-openai`, `langchain-mcp-adapters`, `pydantic`, `aiohttp`, `mcp`
   - Path dep: `fractal-agent-infra` (from `../../infra/fractal_agent_infra`)
   - Build system: setuptools, `src/` layout, `include = ["react_agent*"]`
   - Dev deps: `pytest`, `pytest-asyncio`, `ruff`
   - Ruff config: copy from current `fractal_agent_runtime` package (already tuned)

2. **`README.md`**
   - Brief description: ReAct agent with MCP tools, part of the fractal-agent-graphs catalog
   - Usage example showing `from react_agent import graph`
   - Note on DI pattern for checkpointer/store

3. **`src/react_agent/__init__.py`**
   - Export `graph` from `react_agent.agent`
   - `__version__` via `importlib.metadata`

### Files to Move (from `packages/python/fractal_agent_runtime/src/fractal_agent_runtime/`)

| Source | Destination | Changes Needed |
|--------|-------------|----------------|
| `agent.py` | `src/react_agent/agent.py` | **Critical:** Refactor `graph()` for DI (see below) |
| `utils/mcp_interceptors.py` | `src/react_agent/utils/mcp_interceptors.py` | Update internal imports |
| `utils/token.py` | `src/react_agent/utils/token.py` | Change `store_namespace` import â†’ `fractal_agent_infra` |
| `utils/tools.py` | `src/react_agent/utils/tools.py` | No changes needed |

### Critical Refactor: `agent.py` Dependency Injection

The current `graph()` function has a lazy import at the bottom:

```python
# CURRENT (coupled to robyn_server â€” MUST REMOVE):
try:
    from robyn_server.database import get_checkpointer, get_store
    checkpointer = get_checkpointer()
    store = get_store()
except ImportError:
    checkpointer = None
    store = None
return agent.compile(checkpointer=checkpointer, store=store)
```

Refactor to accept these via keyword arguments:

```python
# NEW (portable â€” runtime injects dependencies):
async def graph(config: RunnableConfig, *, checkpointer=None, store=None):
    ...
    return agent.compile(checkpointer=checkpointer, store=store)
```

This means `robyn_server/agent.py` and `robyn_server/routes/streams.py` (in Task-03) will need to pass `checkpointer=get_checkpointer(), store=get_store()` when calling `graph()`.

### Import Changes Within Moved Files

| File | Old Import | New Import |
|------|-----------|------------|
| `agent.py` | `from fractal_agent_runtime.utils.mcp_interceptors import ...` | `from react_agent.utils.mcp_interceptors import ...` |
| `agent.py` | `from fractal_agent_runtime.utils.token import ...` | `from react_agent.utils.token import ...` |
| `agent.py` | `from fractal_agent_runtime.utils.tools import ...` | `from react_agent.utils.tools import ...` |
| `token.py` | `from fractal_agent_runtime.utils.store_namespace import ...` | `from fractal_agent_infra.store_namespace import ...` |

---

## Acceptance Criteria

- [x] `packages/python/graphs/react_agent/` exists with all files
- [x] `agent.py` has NO `robyn_server` imports (grep confirms â€” 0 references)
- [x] `graph()` accepts `checkpointer` and `store` as keyword arguments
- [x] `uv sync` resolves all dependencies (including `fractal-agent-infra` path dep)
- [x] `uv run ruff check .` passes (1 auto-fixed error, 2 reformatted files, then clean)
- [x] Package is independently importable: `from react_agent import graph`

---

## Dependencies

- **Task-02 (Infra Package)** must be created first or in parallel â€” `token.py` imports `store_namespace` from infra
- Can be done in parallel with Task-02 if both are scaffolded first (directory + pyproject.toml) before moving files

---

## Implementation Notes (Session 5)

- `utils/__init__.py` was left empty â€” all consumers use direct imports (e.g., `from react_agent.utils.token import fetch_tokens`)
- `agent.py` DI refactor was indeed surgical: removed the 11-line `try/except ImportError` block for `robyn_server.database`, changed signature to `async def graph(config: RunnableConfig, *, checkpointer=None, store=None):`, updated log messages from "Postgres" to "injected"
- Ruff config copied from `fractal_agent_runtime/pyproject.toml` with complexity thresholds included
- Internal imports updated: `fractal_agent_runtime.utils.*` â†’ `react_agent.utils.*`
- `token.py` store_namespace import updated: `fractal_agent_runtime.utils.store_namespace` â†’ `fractal_agent_infra.store_namespace`
- `mcp_interceptors.py` docstring import path updated
- Ruff auto-fixed 1 issue (likely import sorting) and reformatted 2 files for line length
- 550 tests pass from `apps/python` â€” the two call sites (`robyn_server/agent.py` L244, `robyn_server/routes/streams.py` L615) now pass `checkpointer=get_checkpointer(), store=get_store()` to `build_agent_graph()`